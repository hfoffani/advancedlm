---
title: "Code Examples"
author: "herchu1"
date: "17 May 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Code Examples

R Markdown see <http://rmarkdown.rstudio.com>.

Setup **code**:

```{r}
data("mtcars")
head(mtcars)
y = mtcars$mpg
x = cbind(1, mtcars$wt, mtcars$hp)
head(x)
```

### Least squares.

Fit with least squares.

$$ (x' * x)^{-1} * x' * y $$

```{r}
solve( t(x) %*% x ) %*% t(x) %*% y
```

R does the same using `lm`

```{r}
coef( lm( mpg ~ wt + hp, data=mtcars ))
```


### Mean centered

A matrix of all-ones is often named as $J$. So given

$$ H = J_n * (J_n' * J_n)^{-1} * J_n' $$
$H$ results on an $n * n$ matrix of all-ones divided by $n$.

```{r}
n = nrow(x)
v1 = matrix(1, n)
H = v1 %*% solve(t(v1) %*% v1) %*% t(v1)
all( H == matrix(1, n, n) / n )
```

Centering `x` to the mean is

$$ (I - H) * x $$

```{r}
I = diag(1, n)
H = matrix(1, n, n) / n

xc = (I - H) %*% x
```

Testing the result. Take the mean of all columns (axis 2).
Using `sweep` can be faster.

```{r}
apply(xc, 2, mean)
xc2 = sweep(x, 2, apply(x, 2, mean))
```

### Variance

Using linear algebra and comparing it with bundled R function `var`.

$$ Variance = \frac{ x' * (I - H) * x }{n-1} $$

```{r}
vx = ( t(x) %*% (I - H) %*% x ) / (n-1)

round(vx, 6)
var(x)
```


### Regression through the origin

The slope of the fit is

$$ \frac{ \tilde{y} \cdot \tilde{x}  }{ \tilde{x} \cdot \tilde{x}  } $$

where $\tilde{y}$ is $y$ mean centered. Same for $\tilde{x}$

Also the slope is (where $\rho_{xy}$ is the covariance between $x$ and $y$)

$$ \rho_{xy} \frac{\sigma_y}{\sigma_x} $$


```{r}
x = mtcars$wt
y = mtcars$disp

yc = y - mean(y)
xc = x - mean(x)
slope = sum( yc * xc ) / sum( xc * xc )
slope
lm(formula = yc ~ xc - 1)
cor(x,y) * sd(y) / sd(x)
```


### Fitting a linear regresion

```{r, echo=FALSE}
plot(x, y)
abline(lm(y ~ x))
```
```{r}
lm(y ~ x)
```

Again the slope $\beta_1$ is:

$$ \rho_{xy} \frac{\sigma_y}{\sigma_x} $$

And the intercept $\beta_0$ is:

$$ \tilde{y} - \rho_{xy} \frac{\sigma_y}{\sigma_x} \tilde{x} $$

```{r}
cor(x,y) * sd(y) / sd(x)
mean(y) - cor(x,y) * sd(y) / sd(x) * mean(x)
```

Same thing as before with the mean centered values:

```{r}
sum(yc * xc) / sum(xc^2)
```


### Fitted values and residuals

The fitted values are

$$ \hat{y} = \beta_0 * J_n + \beta_1 * x $$

and the residuals

$$ e = y - \hat{y} $$

```{r}
Jn = matrix(1, length(x))
beta1 = cor(x,y) * sd(y) / sd(x)
beta0 = mean(y) - beta1 * mean(x)
yhat = beta0 * Jn + beta1 * x
e = y - yhat
```

```{r, echo=FALSE}
plot(x, e)
```

